<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ðŸŽ¤ Voice Coach â€“ PDF Report Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Styles -->
  <style>
    :root{
      --bg:#0b0f1a; --card:#121828; --muted:#9fb3c8; --accent:#29b782; --text:#e8eef6; --line:#1d2436;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:20px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#0d1322,transparent)}
    .container{max-width:1180px;margin:0 auto;padding:18px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px}
    h1{font-size:22px;margin:0 0 4px} h2{font-size:18px;margin:0 0 8px} h3{font-size:16px;margin:18px 0 8px}
    p,li,div,code,label,select,input,small{font-size:14px;line-height:1.55;color:var(--muted)}
    .uploader{border:1px dashed #2a3753;border-radius:12px;padding:18px;text-align:center}
    input[type=file]{display:block;margin:8px auto;color:var(--muted)}
    button{background:var(--accent);color:#062a1f;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;color:var(--text);border:1px solid #2a3753}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
    .select{background:#0b1222;border:1px solid #26304a;border-radius:8px;padding:8px;color:var(--text);width:100%}
    .metrics{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .metric{background:#0f1626;border:1px solid var(--line);border-radius:12px;padding:10px 12px;min-width:120px}
    .metric .k{color:#a9bbd4}.metric .v{font-weight:700;color:#cfe6ff}
    .chat{border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .chat-log{height:320px;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px;background:#0f1423}
    .bubble{max-width:82%;padding:10px 12px;border-radius:12px;white-space:pre-wrap;word-wrap:break-word}
    .bubble.user{align-self:flex-end;background:#1a2236}
    .bubble.bot{align-self:flex-start;background:#13202a;border:1px solid #1d3130}
    .chat-input{display:flex;gap:10px;padding:12px;background:#0e1526;border-top:1px solid var(--line)}
    .chat-input input{flex:1;background:#0b1222;border:1px solid #26304a;border-radius:8px;padding:10px;color:var(--text)}
    .plan{white-space:pre-wrap}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  </style>

  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- pdf.js classic build + worker -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // âœ… MUST be set before any getDocument() calls
    window.pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.worker.min.js";
  </script>
</head>

<body>
  <header>
    <div class="container">
      <h1>ðŸŽ¤ Voice Coach</h1>
      <p class="muted">Upload your <strong>voice report PDF</strong> (Public Speaking / Karaoke / Podcast) to get a tailored, non-medical practice plan.</p>
    </div>
  </header>

  <main class="container">
    <div class="row">
      <!-- Left: Upload + Analysis -->
      <section class="card">
        <h2>1) Upload Report</h2>
        <div class="uploader">
          <input id="pdfInput" type="file" accept="application/pdf" />
          <div style="display:flex;gap:10px;justify-content:center;margin-top:8px">
            <button class="ghost" id="demoBtn">Try Demo (no PDF)</button>
            <button class="ghost" id="clearBtn">Clear</button>
          </div>
          <div class="row2" style="margin-top:12px">
            <label>
              Mode (auto or override)
              <select id="modeSelect" class="select">
                <option value="auto">Auto (from PDF)</option>
                <option value="public_speaking">Public Speaking</option>
                <option value="karaoke">Karaoke</option>
                <option value="podcast">Podcast</option>
              </select>
            </label>
            <label>
              Plan style
              <select id="styleSelect" class="select">
                <option value="balanced">Balanced</option>
                <option value="gentle">Gentle / Recovery</option>
                <option value="intense">Intense / Power</option>
              </select>
            </label>
          </div>
          <p class="muted" style="margin-top:8px">Best with text-based PDFs (scanned images may not parse well).</p>
        </div>

        <div class="hr"></div>
        <h2>2) Findings</h2>
        <div id="metrics" class="metrics"></div>
        <div id="findings"></div>

        <div class="hr"></div>
        <h2>3) Practice Plan</h2>
        <div id="plan" class="plan card" style="background:#0e1424;border-color:#1d2436"></div>
        <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
          <button id="downloadBtn" class="ghost">Download Plan (.md)</button>
          <button id="copyBtn" class="ghost">Copy Plan</button>
          <button id="shortBtn" class="ghost">Make Shorter</button>
          <button id="longBtn" class="ghost">Make Longer</button>
        </div>
      </section>

      <!-- Right: Chat -->
      <section class="card">
        <h2>Chat</h2>
        <div class="chat">
          <div id="chatLog" class="chat-log"></div>
          <div class="chat-input">
            <input id="chatText" type="text" placeholder="Ask about breathing, clarity, projection, fatigue, pitchâ€¦" />
            <button id="sendBtn">Send</button>
          </div>
        </div>

        <p class="muted" style="margin-top:12px"><strong>Note:</strong> Educational guidance only; not medical advice.</p>

        <div class="hr"></div>
        <h3>Extracted Report Text</h3>
        <pre id="raw" class="mono" style="white-space:pre-wrap;background:#0f1423;border:1px solid #1d2436;border-radius:12px;padding:12px;max-height:220px;overflow:auto;"></pre>
      </section>
    </div>
  </main>

  <script>
    // Safety guard in case script order/caching interferes
    if (window.pdfjsLib && (!window.pdfjsLib.GlobalWorkerOptions || !window.pdfjsLib.GlobalWorkerOptions.workerSrc)) {
      window.pdfjsLib.GlobalWorkerOptions = window.pdfjsLib.GlobalWorkerOptions || {};
      window.pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.worker.min.js";
    }

    // Shortcuts
    const $ = s => document.querySelector(s);
    const metricsBox = $("#metrics");
    const findingsBox = $("#findings");
    const planBox = $("#plan");
    const rawBox = $("#raw");
    const modeSelect = $("#modeSelect");
    const styleSelect = $("#styleSelect");
    const chatLog = $("#chatLog");

    let lastPlanMD = "";
    let reportText = "";
    let detectedMode = "public_speaking";
    let planLength = "balanced"; // 'short' | 'balanced' | 'long'

    /* ---------- PDF extraction ---------- */
    async function readPdf(file) {
      // Reject obviously wrong types early
      if (!file || file.type !== "application/pdf") throw new Error("Please select a PDF file.");

      // Read in memory and hand to pdf.js
      const arrayBuffer = await file.arrayBuffer();
      const loadingTask = window.pdfjsLib.getDocument({ data: arrayBuffer });
      const pdf = await loadingTask.promise;

      let text = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent({ normalizeWhitespace: true });
        text += content.items.map(it => it.str).join(" ") + "\n";
      }
      return text.trim();
    }

    /* ---------- Helpers ---------- */
    const toFloat = v => v==null?null:(n=>Number.isFinite(n)?n:null)(
      parseFloat(String(v).replace(/[^0-9.\-]/g,""))
    );
    const find = (re, s) => {
      const m = s.match(re);
      return m ? m[1] : null;
    };

    function detectModeFrom(text){
      const t = (text||"").toLowerCase();
      if (t.includes("karaoke")) return "karaoke";
      if (t.includes("public speaking")) return "public_speaking";
      if (t.includes("podcast")) return "podcast";
      return "public_speaking";
    }

    function block(title, items){ return { title, items }; }
    function uniqueBlocks(blocks){
      const map = {};
      for (const b of blocks){
        if (!map[b.title]) map[b.title] = [];
        for (const it of b.items) if (!map[b.title].includes(it)) map[b.title].push(it);
      }
      return Object.keys(map).map(k => ({ title:k, items:map[k] }));
    }

    const base = {
      warmup: block("Daily Warm-up (5â€“7 min)", [
        "Neck/shoulder roll + jaw massage (1 min).",
        "Lip trills or straw phonation (2 min).",
        "Hums â†’ 5-step sirens (2â€“3 min)."
      ]),
      cooldown: block("Cool-down (2â€“3 min)", [
        "Gentle hums, descending slides.",
        "SOVT (straw/lip) 60â€“90 s.",
        "2 minutes quiet voice or rest."
      ]),
      breath: block("Breath Support", [
        "Diaphragmatic 4â€“4â€“6 Ã— 10.",
        "Sustain 'sss' and 'zzz' with even airstream (6 reps each).",
        "Light panting â†’ slow 'ffff' exhale (5 min total)."
      ]),
      pitch: block("Pitch Stability", [
        "Hum glides lowâ†’highâ†’low (5 min).",
        "SOVT: straw phonation in water, 3 Ã— 1 min.",
        "Gentle sirens on 'ng' to smooth transitions."
      ]),
      loudness: block("Loudness Control", [
        "Crescendoâ€“decrescendo on sustained 'ah' (5s up/5s down) Ã— 5.",
        "Lip trills at steady volume (3 min).",
        "Count 1â€“10: soft â†’ medium â†’ loud â†’ soft."
      ]),
      glottal: block("Glottal Efficiency", [
        "S/Z drills: alternate sustained /s/ and /z/, match durations (5 pairs).",
        "Resonant hums ('mmm') with forward buzz (3 min).",
        "Straw phonation (air only â†’ voiced), 3 Ã— 1 min."
      ]),
      fatigue: block("Reduce Hoarseness / Fatigue", [
        "Hydrate 2â€“3 L/day; warm water before/after heavy use.",
        "SOVT toolkit: straw/lip/tongue trills 5â€“8 min/day.",
        "Micro-rests: 5 min quiet each hour of heavy use."
      ]),
      resonance: block("Resonance Balance", [
        "Hum 'mmm' â†’ open to 'ma' without losing forward buzz.",
        "Nasalâ€“oral contrast: 'meeâ€“mayâ€“mahâ€“mohâ€“moo' (3 sets).",
        "Light 'Y-buzz' phrases to center forward resonance (3 min)."
      ]),
      detension: block("Release Excess Tension", [
        "Neck/shoulder stretches (no pain), 3 min.",
        "Yawnâ€“sigh glides to reset laryngeal tension (10 reps).",
        "Low-effort speaking 2 semitones below habitual for ~2 min."
      ]),
      clarity: block("Articulation & Clarity", [
        "Exaggerated tongue twisters (slow â†’ natural), 3â€“5 min.",
        "Consonant bursts: 'p t k' then crisp phrases.",
        "Smile-read: 1 paragraph with light smile to brighten tone."
      ]),
      publicSpeaking: block("Public Speaking Focus", [
        "Pace at ~140â€“160 wpm; breathe at punctuation.",
        "Projection without push: 'mmm' â†’ words.",
        "Articulation ladder: tongue twisters 3 min."
      ]),
      karaoke: block("Karaoke Focus", [
        "5-step sirens before singing.",
        "Verse-only run-through at ~70% volume.",
        "Crescendoâ€“decrescendo on vowels (5 reps)."
      ]),
      podcast: block("Podcast Focus", [
        "Consistency set: read 2 paragraphs at even SPL.",
        "Mic discipline: 6â€“8 cm, 20Â° off-axis, pop-filter.",
        "Warm, close tone: hum-to-speech transitions."
      ])
    };

    function styleAdjust(blocks, style){
      if (style === "gentle"){
        return blocks.map(b => ({
          title:b.title,
          items: b.title.includes("Loudness") ? b.items.filter((_,i)=>i!==0) : b.items
        }));
      }
      if (style === "intense"){
        return blocks.map(b => {
          const items = [...b.items];
          if (b.title.includes("Breath") && !items.find(x=>x.includes("Box breathing")))
            items.push("Box breathing 4â€“4â€“4â€“4 Ã— 10 cycles.");
          if (b.title.includes("Pitch") && !items.find(x=>x.includes("Octave")))
            items.push("Octave sirens (light) with no strain, 3 min.");
          return { title:b.title, items };
        });
      }
      return blocks;
    }

    function analyzeReport(text) {
      const t = text || "";
      const lower = t.toLowerCase();

      const metrics = {
        jitter_pct: toFloat(find(/jitter[^0-9%]*([0-9.]+)\s*%/i, t)),
        shimmer_pct: toFloat(find(/shimmer[^0-9%]*([0-9.]+)\s*%/i, t)),
        mpt_sec:    toFloat(find(/(?:maximum\s+phonation\s+time|mpt)[^0-9]*([0-9.]+)\s*s/i, t)),
        sz_ratio:   toFloat(find(/s\/z\s*ratio[^0-9]*([0-9.]+)/i, t)),
        f0_hz:      toFloat(find(/(?:f0|fundamental\s+frequency)[^0-9]*([0-9.]+)\s*hz/i, t)),
        intensity_db: toFloat(find(/(?:intensity|spl)[^0-9]*([0-9.]+)\s*db/i, t))
      };

      const findings = [];
      const blocks = [];

      if (metrics.jitter_pct != null) {
        if (metrics.jitter_pct > 1.0) { findings.push(`Elevated jitter (${metrics.jitter_pct}%).`); blocks.push(base.pitch); }
        else findings.push(`Jitter in typical range (${metrics.jitter_pct}%).`);
      }
      if (metrics.shimmer_pct != null) {
        if (metrics.shimmer_pct > 3.5) { findings.push(`Elevated shimmer (${metrics.shimmer_pct}%).`); blocks.push(base.loudness); }
        else findings.push(`Shimmer in typical range (${metrics.shimmer_pct}%).`);
      }
      if (metrics.mpt_sec != null) {
        if (metrics.mpt_sec < 15) { findings.push(`Short MPT (${metrics.mpt_sec}s).`); blocks.push(base.breath); }
        else findings.push(`MPT looks adequate (${metrics.mpt_sec}s).`);
      }
      if (metrics.sz_ratio != null) {
        if (metrics.sz_ratio < 0.8 || metrics.sz_ratio > 1.2) { findings.push(`S/Z ratio outside ~0.8â€“1.2 (${metrics.sz_ratio}).`); blocks.push(base.glottal); }
        else findings.push(`S/Z ratio in typical band (${metrics.sz_ratio}).`);
      }
      if (metrics.f0_hz != null) findings.push(`F0: ${metrics.f0_hz} Hz.`);
      if (metrics.intensity_db != null) findings.push(`Intensity: ${metrics.intensity_db} dB.`);

      const K = (...ws)=>ws.some(w=>lower.includes(w));
      if (K("hoarse","hoarseness","raspy","fatigue")) blocks.push(base.fatigue);
      if (K("nasal","nasality")) blocks.push(base.resonance);
      if (K("tension","pressed","hyperfunction","strain")) blocks.push(base.detension);
      if (K("clarity","articulation","diction","slurred")) blocks.push(base.clarity);

      const mode = (modeSelect.value==="auto" ? detectedMode : modeSelect.value);
      if (mode==="public_speaking") blocks.push(base.publicSpeaking);
      if (mode==="karaoke")         blocks.push(base.karaoke);
      if (mode==="podcast")         blocks.push(base.podcast);

      blocks.push(base.warmup, base.cooldown);
      const styled = styleAdjust(blocks, styleSelect.value);
      const plan = uniqueBlocks(styled);
      return { metrics, findings, plan, mode };
    }

    function renderAnalysis(res) {
      // metrics
      metricsBox.innerHTML = "";
      [["Jitter %",res.metrics.jitter_pct],["Shimmer %",res.metrics.shimmer_pct],["MPT (s)",res.metrics.mpt_sec],["S/Z ratio",res.metrics.sz_ratio],["F0 (Hz)",res.metrics.f0_hz],["Intensity (dB)",res.metrics.intensity_db]]
        .forEach(([k,v])=>{
          const d=document.createElement("div");
          d.className="metric";
          d.innerHTML=`<div class="k">${k}</div><div class="v">${v ?? "â€”"}</div>`;
          metricsBox.appendChild(d);
        });

      // findings
      findingsBox.innerHTML = `<p><strong>Mode:</strong> ${res.mode.replace("_"," ")}</p>`;
      if (res.findings?.length){
        const ul=document.createElement("ul");
        res.findings.forEach(f=>{const li=document.createElement("li"); li.textContent=f; ul.appendChild(li);});
        findingsBox.appendChild(ul);
      } else {
        findingsBox.innerHTML += `<p class="muted">No specific metrics found â€” plan generated from general cues.</p>`;
      }

      // plan
      let md = `# Personalized Voice Plan\n**Note:** Educational guidance only; not medical advice.\n\n`;
      if (res.findings?.length) md += `## Findings\n` + res.findings.map(f=>`- ${f}`).join("\n") + "\n\n";
      md += `## Practice Plan\n`;
      res.plan.forEach(b=>{
        let items=[...b.items];
        if (planLength==="short") items = items.slice(0, Math.max(2, Math.ceil(items.length*0.5)));
        if (planLength==="long") items = items.concat(items.length? [`Track progress: note comfort & control after set.`] : []);
        md += `### ${b.title}\n` + items.map(i=>`- ${i}`).join("\n") + "\n\n";
      });
      lastPlanMD = md;
      planBox.innerHTML = marked.parse(md);
    }

    /* ---------- Chat ---------- */
    function addBubble(role, text){
      const div=document.createElement("div");
      div.className=`bubble ${role==="user"?"user":"bot"}`;
      div.innerHTML = role==="bot" ? marked.parse(text) : text;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    const bank = {
      breathBase: [
        `**Breathing Mini-Block (6â€“8 min)**\n- Diaphragmatic 4â€“4â€“6 Ã— 10\n- Sustained /sss/ steady airstream Ã— 6\n- Straw phonation (airâ†’voice) 3 Ã— 60s\n- Read aloud; breathe at punctuation`,
        `**Airflow Builder**\n- Box breathing 4â€“4â€“4â€“4 for 2 min\n- Hiss "sss" then voiced "zzz" (5 reps each)\n- Long gentle 'ffff' exhale while counting`
      ],
      breathKaraoke: [
        `**Singing Breath**\n- 5-step sirens on 'oo'\n- Phrase breaths at commas\n- 3Ã—45s lip trills before chorus`
      ],
      breathPublic: [
        `**Speaking Breath**\n- Nose inhale, mouth exhale at punctuation\n- Read 2 paragraphs evenly\n- 90s straw phonation to center airflow`
      ],
      breathPodcast: [
        `**Podcast Breath**\n- 8 slow diaphragmatic breaths\n- Even SPL reading (2 min)\n- Soft humâ†’speech entries`
      ],
      clarity: [
        `**Clarity & Diction**\n- Exaggerated tongue-twisters (3 min)\n- Consonant bursts "p t k" â†’ phrases\n- Smile-read one paragraph`,
        `**Crisp Speech**\n- Count 1â€“20 over-articulated\n- Headline reading: emphasize consonants\n- 'mmm'â†’'ma' keeping forward buzz`
      ],
      projection: [
        `**Projection Without Push**\n- 'mmm' â†’ words (forward resonance)\n- Count 1â€“10 medium volume\n- 3Ã—45s lip trills`,
        `**Resonant Projection**\n- Y-buzz phrases (You, Youngâ€¦)\n- Vowel cresc/decresc 5s up/5s down Ã— 5\n- Jaw loose, chest quiet`
      ],
      fatigue: [
        `**Anti-Fatigue**\n- Hydrate; warm water\n- SOVT 5â€“8 min/day in short sets\n- 5-min quiet each heavy-use hour\n- Replace throat clearing with silent cough`,
        `**Recovery**\n- 2 min quiet hums\n- 60â€“90s straw phonation\n- Gentle descending slides`
      ],
      pitch: [
        `**Pitch Stability**\n- Hum glides lowâ†’highâ†’low (3 min)\n- 'ng' sirens\n- Straw phonation 3Ã—60s`,
        `**Smooth Registers**\n- 5-step sirens on "oo"\n- Glide into speech without breaks\n- Track comfort, not range`
      ],
      warmupQuick: [
        `**Quick Warm-up (5â€“6 min)**\n- Lip/tongue trills 2 min\n- Hum slides 2 min\n- Read a paragraph; breathe at punctuation`,
        `**Speed Warm-up**\n- Jaw/neck release (30s)\n- Straw phonation (60s)\n- Hums â†’ 5-step sirens (2 min)\n- Read 8 lines clearly`
      ]
    };

    function modeAwareBreath(mode){
      const baseMsg = bank.breathBase[Math.floor(Math.random()*bank.breathBase.length)];
      const add = mode==="karaoke" ? bank.breathKaraoke :
                  mode==="podcast" ? bank.breathPodcast :
                  mode==="public_speaking" ? bank.breathPublic : [];
      const extra = (add && add.length) ? "\n\n"+add[Math.floor(Math.random()*add.length)] : "";
      return baseMsg + extra;
    }

    function isVoiceRelated(q){
      const p=q.toLowerCase();
      return /(voice|breath|breathing|airflow|support|sing|karaoke|public|podcast|speech|clarity|articulation|diction|projection|pitch|resonance|jitter|shimmer|mpt|s\/z|fatigue|hoarse|tension|volume)/.test(p);
    }

    async function replyFor(text){
      const p = text.toLowerCase();
      if (!isVoiceRelated(p)) {
        return "I can help with **voice, breathing, clarity, projection, pitch, resonance**. Please ask something in that area ðŸ™‚";
      }
      const mode = (modeSelect.value==="auto" ? detectedMode : modeSelect.value);
      if (/(breath|breathing|airflow|support|diaphragm)/.test(p)) return modeAwareBreath(mode);
      if (/(clarity|articulation|diction|pronunciation)/.test(p)) return bank.clarity[Math.floor(Math.random()*bank.clarity.length)];
      if (/(project|projection|loud|volume)/.test(p))           return bank.projection[Math.floor(Math.random()*bank.projection.length)];
      if (/(fatigue|hoarse|raspy|tired)/.test(p))               return bank.fatigue[Math.floor(Math.random()*bank.fatigue.length)];
      if (/(pitch|jitter)/.test(p))                              return bank.pitch[Math.floor(Math.random()*bank.pitch.length)];
      if (/(plan|routine|program|summary)/.test(p))              return lastPlanMD || "Upload your PDF (or click Demo) to generate a personalized plan first.";
      return bank.warmupQuick[Math.floor(Math.random()*bank.warmupQuick.length)];
    }

    /* ---------- Events ---------- */
    $("#pdfInput").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      rawBox.textContent = "Reading PDFâ€¦";
      try {
        reportText = await readPdf(file);
        detectedMode = detectModeFrom(reportText);
        if (modeSelect.value==="auto") {
          const opt = Array.from(modeSelect.options).find(o=>o.value===detectedMode);
          if (opt) modeSelect.title = `Detected: ${opt.text}`;
        }
        rawBox.textContent = reportText;
        const res = analyzeReport(reportText);
        renderAnalysis(res);
        addBubble("bot", "âœ… PDF loaded. Ask for **breathing**, **clarity**, **projection**, or say **plan**.");
      } catch (err) {
        rawBox.textContent = "[ERROR] Could not read PDF: " + (err?.message || err);
        addBubble("bot", "âŒ I couldn't read that PDF. Is it a scanned/photo PDF? Try a text-based PDF or the Demo.");
      }
    });

    $("#demoBtn").addEventListener("click", () => {
      reportText = `Voice Report
      Mode: Public Speaking
      Jitter 1.6 %
      Shimmer 4.2 %
      Maximum Phonation Time 12 s
      S/Z ratio 1.5
      Notes: hoarseness after speaking, mild nasality, some tension.`;
      detectedMode = "public_speaking";
      rawBox.textContent = reportText;
      const res = analyzeReport(reportText);
      renderAnalysis(res);
      addBubble("bot", "âœ… Demo report loaded. Try: **breathing**, **clarity**, **projection**, or **plan**.");
    });

    $("#clearBtn").addEventListener("click", () => {
      reportText = "";
      rawBox.textContent = "";
      metricsBox.innerHTML = "";
      findingsBox.innerHTML = "";
      planBox.innerHTML = "";
      lastPlanMD = "";
      addBubble("bot", "Cleared. Upload a new PDF or try the Demo.");
    });

    $("#downloadBtn").addEventListener("click", () => {
      if (!lastPlanMD) { addBubble("bot","No plan yetâ€”upload a PDF or click Demo."); return; }
      const blob = new Blob([lastPlanMD], {type:"text/markdown"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "voice_plan.md";
      a.click();
    });

    $("#copyBtn").addEventListener("click", async () => {
      if (!lastPlanMD) { addBubble("bot","No plan yet to copy."); return; }
      await navigator.clipboard.writeText(lastPlanMD);
      addBubble("bot","ðŸ“‹ Plan copied to clipboard!");
    });

    $("#shortBtn").addEventListener("click", () => {
      if (!reportText){ addBubble("bot","Load a PDF or click Demo first."); return; }
      planLength = "short";
      renderAnalysis(analyzeReport(reportText));
      addBubble("bot","Made the plan **shorter**.");
    });

    $("#longBtn").addEventListener("click", () => {
      if (!reportText){ addBubble("bot","Load a PDF or click Demo first."); return; }
      planLength = "long";
      renderAnalysis(analyzeReport(reportText));
      addBubble("bot","Made the plan **longer**.");
    });

    $("#sendBtn").addEventListener("click", async () => {
      const input = $("#chatText");
      const msg = input.value.trim();
      if (!msg) return;
      addBubble("user", msg);
      input.value = "";
      const reply = await replyFor(msg);
      addBubble("bot", reply);
    });

    document.addEventListener("keydown", (e) => {
      if (e.key.toLowerCase() === "p") renderAnalysis(analyzeReport(reportText || ""));
      if (e.key === "Enter" && document.activeElement === $("#chatText")) $("#sendBtn").click();
    });
  </script>
</body>
</html>
