<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Voice Coach â€“ PDF Report Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Minimal, clean styles -->
  <style>
    :root{--bg:#0b0f1a;--card:#121828;--muted:#9fb3c8;--accent:#29b782;--text:#e8eef6;}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    header{padding:20px 16px;border-bottom:1px solid #1d2436;background:linear-gradient(180deg,#0d1322,transparent);}
    .container{max-width:1100px;margin:0 auto;padding:18px;}
    .card{background:var(--card);border:1px solid #1d2436;border-radius:16px;padding:18px;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .row-1{display:grid;grid-template-columns:1fr;gap:18px}
    h1{font-size:22px;margin:0 0 4px}
    h2{font-size:18px;margin:0 0 8px}
    h3{font-size:16px;margin:18px 0 8px}
    p,li,div,code{font-size:14px;line-height:1.5;color:var(--muted)}
    .pill{display:inline-block;background:#0f1a2a;border:1px solid #1d2436;padding:6px 10px;border-radius:999px}
    .uploader{border:1px dashed #2a3753;border-radius:12px;padding:18px;text-align:center}
    input[type=file]{display:block;margin:8px auto;color:var(--muted)}
    button{background:var(--accent);color:#062a1f;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;color:var(--text);border:1px solid #2a3753}
    .metrics{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .metric{background:#0f1626;border:1px solid #1d2436;border-radius:12px;padding:10px 12px;min-width:110px}
    .chat{border:1px solid #1d2436;border-radius:12px;overflow:hidden}
    .chat-log{height:280px;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px;background:#0f1423}
    .bubble{max-width:80%;padding:10px 12px;border-radius:12px}
    .user{align-self:flex-end;background:#1a2236}
    .bot{align-self:flex-start;background:#13202a;border:1px solid #1d3130}
    .chat-input{display:flex;gap:10px;padding:12px;background:#0e1526;border-top:1px solid #1d2436}
    .plan{white-space:pre-wrap}
    .muted{opacity:.8}
    .kbd{border:1px solid #2a3753;border-bottom-width:2px;border-radius:6px;padding:2px 6px;font-family:ui-monospace,monospace;font-size:12px;color:#cfe6ff}
    a{color:#8dd7ff;text-decoration:none}
  </style>

  <!-- pdf.js (read PDFs in browser) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.js" integrity="sha512-Nb3szZP3bX0aGQm9mLr0Xk1U0dR8VXwk8t3r8B6pI3cI3Ttq6tV3l6j2zB9Q80rQ4m6k2wqUqXv3h7M2y8bF2A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- marked.js (render Markdown nicely) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <h1>ðŸŽ¤ Voice Coach</h1>
      <p class="muted">Upload your <strong>voice report PDF</strong>; get a tailored, non-medical plan (breathing, stability, clarity). Runs entirely in your browser.</p>
    </div>
  </header>

  <main class="container">
    <div class="row">
      <section class="card">
        <h2>1) Upload Report</h2>
        <div class="uploader">
          <input id="pdfInput" type="file" accept="application/pdf" />
          <button class="ghost" id="demoBtn">Try Demo (no PDF)</button>
          <p class="muted" style="margin-top:8px">We only read text. Scanned images may not parse well.</p>
        </div>
        <div style="margin-top:14px">
          <span class="pill">Tip</span>
          <span class="muted">Press <span class="kbd">P</span> to re-run analysis after edits.</span>
        </div>

        <h2 style="margin-top:16px">2) Findings</h2>
        <div id="metrics" class="metrics"></div>
        <div id="findings"></div>

        <h2 style="margin-top:16px">3) Practice Plan</h2>
        <div id="plan" class="plan card" style="background:#0e1424;border-color:#1d2436"></div>
        <div style="margin-top:10px;display:flex;gap:10px">
          <button id="downloadBtn" class="ghost">Download Plan (.md)</button>
          <button id="copyBtn" class="ghost">Copy Plan</button>
        </div>
      </section>

      <section class="card">
        <h2>Chat</h2>
        <div class="chat">
          <div id="chatLog" class="chat-log"></div>
          <div class="chat-input">
            <input id="chatText" type="text" placeholder="Ask for breathing drills, warm-up, clarity tipsâ€¦" style="flex:1;background:#0b1222;border:1px solid #26304a;border-radius:8px;padding:10px;color:var(--text)"/>
            <button id="sendBtn">Send</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <p class="muted"><strong>Note:</strong> Educational guidance only; not medical advice. For any clinical issues, consult a licensed SLP/ENT.</p>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:18px">
      <h2>Extracted Report Text (preview)</h2>
      <pre id="raw" style="white-space:pre-wrap;background:#0f1423;border:1px solid #1d2436;border-radius:12px;padding:12px;max-height:260px;overflow:auto;"></pre>
    </section>
  </main>

<script>
/* ---------------- Utilities ---------------- */
const $ = sel => document.querySelector(sel);
const metricsBox = $("#metrics");
const findingsBox = $("#findings");
const planBox = $("#plan");
const rawBox = $("#raw");
let lastPlanMD = "";
let reportText = "";

/* PDF extraction using pdf.js */
async function readPdf(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let fullText = "";
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const text = await page.getTextContent();
    const strings = text.items.map(item => item.str);
    fullText += strings.join(" ") + "\n";
  }
  return fullText;
}

/* Helpers */
const toFloat = v => {
  if (v == null) return null;
  const s = String(v).replace(/[^0-9.\-]/g,"");
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : null;
};
const findMetric = (pattern, text) => {
  const m = text.match(pattern);
  return m ? m[1] : null;
};

/* Core: analyze text and build plan */
function analyzeReport(text) {
  const t = text || "";
  const lower = t.toLowerCase();
  const metrics = {
    jitter_pct: toFloat(findMetric(/jitter[^0-9%]*([0-9.]+)\s*%/i, t)),
    shimmer_pct: toFloat(findMetric(/shimmer[^0-9%]*([0-9.]+)\s*%/i, t)),
    mpt_sec: toFloat(findMetric(/(?:maximum\s+phonation\s+time|mpt)[^0-9]*([0-9.]+)\s*s/i, t)),
    sz_ratio: toFloat(findMetric(/s\/z\s*ratio[^0-9]*([0-9.]+)/i, t)),
    f0_hz: toFloat(findMetric(/(?:f0|fundamental\s+frequency)[^0-9]*([0-9.]+)\s*hz/i, t)),
    intensity_db: toFloat(findMetric(/(?:intensity|spl)[^0-9]*([0-9.]+)\s*db/i, t))
  };

  const findings = [];
  const blocks = [];

  if (metrics.jitter_pct != null) {
    if (metrics.jitter_pct > 1.0) {
      findings.push(`Elevated jitter (${metrics.jitter_pct}%). Possible pitch instability/roughness.`);
      blocks.push(["Pitch Stability", [
        "Humming glides from low â†’ comfortable high â†’ low (5 min).",
        "SOVT: straw phonation in water, 3 Ã— 1 min.",
        "Gentle sirens on 'ng' to smooth registers (3 min)."
      ]]);
    } else findings.push(`Jitter in typical range (${metrics.jitter_pct}%).`);
  }

  if (metrics.shimmer_pct != null) {
    if (metrics.shimmer_pct > 3.5) {
      findings.push(`Elevated shimmer (${metrics.shimmer_pct}%). Potential loudness/control instability.`);
      blocks.push(["Loudness Control", [
        "Crescendoâ€“decrescendo on sustained 'ah' (5s up, 5s down), 5 reps.",
        "Lip trills at steady volume (3 min).",
        "Count 1â€“10: soft â†’ medium â†’ loud â†’ soft with clarity."
      ]]);
    } else findings.push(`Shimmer in typical range (${metrics.shimmer_pct}%).`);
  }

  if (metrics.mpt_sec != null) {
    if (metrics.mpt_sec < 15) {
      findings.push(`Short Maximum Phonation Time (${metrics.mpt_sec}s). May indicate breath support limits.`);
      blocks.push(["Breath Support", [
        "Diaphragmatic 4â€“4â€“6: inhale 4, hold 4, exhale 6 Ã— 10.",
        "Sustain 'sss' and 'zzz' with even airstream (6 reps each).",
        "Light panting â†’ slow exhale on 'ffff' (5 min total)."
      ]]);
    } else findings.push(`MPT looks adequate (${metrics.mpt_sec}s).`);
  }

  if (metrics.sz_ratio != null) {
    if (metrics.sz_ratio < 0.8 || metrics.sz_ratio > 1.2) {
      findings.push(`S/Z ratio outside typical band (~0.8â€“1.2): ${metrics.sz_ratio}.`);
      blocks.push(["Glottal Efficiency", [
        "S/Z drills: alternate sustained /s/ and /z/, match durations; 5 pairs.",
        "Resonant hums ('mmm') with forward buzz (3 min).",
        "Straw phonation (air only â†’ voiced) to balance flow/closure, 3 Ã— 1 min."
      ]]);
    } else findings.push(`S/Z ratio in typical band (${metrics.sz_ratio}).`);
  }

  if (metrics.f0_hz != null) findings.push(`Reported F0: ${metrics.f0_hz} Hz.`);
  if (metrics.intensity_db != null) findings.push(`Reported intensity: ${metrics.intensity_db} dB.`);

  const k = (...ws) => ws.some(w => lower.includes(w));
  if (k("hoarse","hoarseness","rough","raspy")) {
    blocks.push(["Reduce Hoarseness / Fatigue", [
      "Hydrate 2â€“3 L/day; warm water before/after heavy use.",
      "SOVT toolkit: straw/lip/tongue trills 5â€“8 min/day in short sets.",
      "Micro-rests: 5 min quiet each hour of heavy voice use."
    ]]);
  }
  if (k("nasal","nasality")) {
    blocks.push(["Resonance Balance", [
      "Hum 'mmm' â†’ open to 'ma' without losing forward buzz.",
      "Nasalâ€“oral contrast: 'meeâ€“mayâ€“mahâ€“mohâ€“moo' (3 sets).",
      "Light 'Y-buzz' phrases to center forward resonance (3 min)."
    ]]);
  }
  if (k("articulation","clarity","slurred","diction")) {
    blocks.push(["Articulation & Clarity", [
      "Exaggerated tongue twisters (slow â†’ natural), 5 min.",
      "Consonant bursts: 'p t k' then crisp phrases.",
      "Smile-read: 1 paragraph with light smile to brighten tone."
    ]]);
  }
  if (k("strain","pressed","hyperfunction","tension")) {
    blocks.push(["Release Excess Tension", [
      "Neck/shoulder stretches (no pain), 3 min.",
      "Yawnâ€“sigh glides to reset laryngeal tension (10 reps).",
      "Low-effort speaking: 2 semitones below habitual for ~2 min."
    ]]);
  }
  if (k("breath","breathing","support","airflow")) {
    blocks.push(["Breathing Foundation", [
      "Box breathing 4â€“4â€“4â€“4 Ã— 10 cycles.",
      "Sustained fricatives 'sss/fff' with steady flow (6 reps).",
      "Read aloud; breathe at punctuation marks."
    ]]);
  }

  // Always include warm-up & cool-down
  blocks.push(["Daily Warm-up (5â€“7 min)", [
    "Neck/shoulder roll + jaw massage (1 min).",
    "Lip trills or straw phonation (2 min).",
    "Hums â†’ 5-step sirens (2â€“3 min)."
  ]]);
  blocks.push(["Cool-down (2â€“3 min)", [
    "Gentle hums, descending slides.",
    "SOVT (straw/lip trill) 60â€“90s.",
    "2 minutes quiet voice or rest."
  ]]);

  // De-duplicate by title
  const dedup = {};
  for (const [title, items] of blocks) {
    dedup[title] = dedup[title] || [];
    for (const it of items) if (!dedup[title].includes(it)) dedup[title].push(it);
  }

  const plan = [];
  for (const title of Object.keys(dedup)) plan.push({ title, items: dedup[title] });

  return { metrics, findings, plan };
}

/* Render functions */
function renderAnalysis(res) {
  metricsBox.innerHTML = "";
  const m = res.metrics;
  const entries = [
    ["Jitter %", m.jitter_pct],
    ["Shimmer %", m.shimmer_pct],
    ["MPT (s)", m.mpt_sec],
    ["S/Z ratio", m.sz_ratio],
    ["F0 (Hz)", m.f0_hz],
    ["Intensity (dB)", m.intensity_db],
  ];
  for (const [k,v] of entries) {
    const div = document.createElement("div");
    div.className = "metric";
    div.innerHTML = `<div class="muted">${k}</div><div style="font-weight:700;color:#cfe6ff">${v ?? "â€”"}</div>`;
    metricsBox.appendChild(div);
  }

  findingsBox.innerHTML = "";
  if (res.findings?.length) {
    const ul = document.createElement("ul");
    res.findings.forEach(f => {
      const li = document.createElement("li"); li.textContent = f; ul.appendChild(li);
    });
    findingsBox.appendChild(ul);
  } else {
    findingsBox.innerHTML = `<p class="muted">No specific metrics foundâ€”plan still generated from general cues.</p>`;
  }

  let md = `# Personalized Voice Plan\n**Note:** Educational guidance only; not medical advice.\n\n`;
  if (res.findings?.length) {
    md += `## Findings\n` + res.findings.map(f=>`- ${f}`).join("\n") + "\n\n";
  }
  md += `## Practice Plan\n`;
  res.plan.forEach(block => {
    md += `### ${block.title}\n` + block.items.map(i=>`- ${i}`).join("\n") + "\n\n";
  });
  lastPlanMD = md;
  planBox.innerHTML = marked.parse(md);
}

/* Chat */
function botReplyFor(text) {
  const p = text.toLowerCase();
  if (/\b(breath|breath|diaphragm|support)\b/.test(p)) {
    return `### Breathing Mini-Block (6â€“8 min)
- Diaphragmatic 4â€“4â€“6 Ã— 10
- Sustained /sss/ steady airstream Ã— 6
- Straw phonation (air â†’ voice) 3 Ã— 60s
- Read aloud; breathe at punctuation`;
  }
  if (/\b(hoarse|raspy|fatigue|tired)\b/.test(p)) {
    return `### Anti-Fatigue Toolkit
- Hydrate; warm/room-temp water
- SOVT (straw/lip) 5â€“8 min/day in short sets
- Micro-rests: 5 min quiet each hour
- Avoid throat clearing; use a silent cough`;
  }
  if (/\b(plan|routine|program|summary)\b/.test(p)) {
    return lastPlanMD || "Upload your PDF to generate a personalized plan first.";
  }
  return `Try this versatile set:
- Warm-up: lip/tongue trills (2 min) â†’ hum slides (2 min)
- Articulation: exaggerated tongue twisters (3 min)
- Resonance: 'mmm' â†’ 'ma' keeping forward buzz (2 min)
Ask about breathing, hoarseness, clarity, or say â€œplanâ€.`;
}

function addBubble(role, text) {
  const log = $("#chatLog");
  const div = document.createElement("div");
  div.className = `bubble ${role === "user" ? "user" : "bot"}`;
  div.innerHTML = role === "bot" ? marked.parse(text) : text;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

/* Event wiring */
$("#pdfInput").addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  rawBox.textContent = "Reading PDFâ€¦";
  try {
    reportText = await readPdf(file);
    rawBox.textContent = reportText;
    const res = analyzeReport(reportText);
    renderAnalysis(res);
  } catch (err) {
    rawBox.textContent = "[ERROR] Could not read PDF: " + err;
  }
});

$("#demoBtn").addEventListener("click", () => {
  reportText = `Voice Report
  Jitter 1.6 %
  Shimmer 4.2 %
  Maximum Phonation Time 12 s
  S/Z ratio 1.5
  Notes: hoarseness after speaking, mild nasality.`;
  rawBox.textContent = reportText;
  const res = analyzeReport(reportText);
  renderAnalysis(res);
});

$("#downloadBtn").addEventListener("click", () => {
  if (!lastPlanMD) return;
  const blob = new Blob([lastPlanMD], {type:"text/markdown"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "voice_plan.md";
  a.click();
});

$("#copyBtn").addEventListener("click", async () => {
  if (!lastPlanMD) return;
  await navigator.clipboard.writeText(lastPlanMD);
  alert("Plan copied to clipboard!");
});

$("#sendBtn").addEventListener("click", () => {
  const input = $("#chatText");
  const msg = input.value.trim();
  if (!msg) return;
  addBubble("user", msg);
  input.value = "";
  const reply = botReplyFor(msg);
  addBubble("bot", reply);
});

document.addEventListener("keydown", (e) => {
  if (e.key.toLowerCase() === "p") {
    const res = analyzeReport(reportText || "");
    renderAnalysis(res);
  }
});
</script>
</body>
</html>
