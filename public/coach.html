<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Voice Coach â€“ PDF Report Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b0f1a;--card:#121828;--muted:#9fb3c8;--accent:#29b782;--text:#e8eef6;}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    header{padding:20px 16px;border-bottom:1px solid #1d2436;background:linear-gradient(180deg,#0d1322,transparent);}
    .container{max-width:1100px;margin:0 auto;padding:18px;}
    .card{background:var(--card);border:1px solid #1d2436;border-radius:16px;padding:18px;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    h1{font-size:22px;margin:0 0 4px}
    h2{font-size:18px;margin:0 0 8px}
    h3{font-size:16px;margin:18px 0 8px}
    p,li,div,code,label,select,input{font-size:14px;line-height:1.5;color:var(--muted)}
    .pill{display:inline-block;background:#0f1a2a;border:1px solid #1d2436;padding:6px 10px;border-radius:999px}
    .uploader{border:1px dashed #2a3753;border-radius:12px;padding:18px;text-align:center}
    input[type=file]{display:block;margin:8px auto;color:var(--muted)}
    button{background:var(--accent);color:#062a1f;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;color:var(--text);border:1px solid #2a3753}
    .metrics{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .metric{background:#0f1626;border:1px solid #1d2436;border-radius:12px;padding:10px 12px;min-width:110px}
    .chat{border:1px solid #1d2436;border-radius:12px;overflow:hidden}
    .chat-log{height:280px;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px;background:#0f1423}
    .bubble{max-width:80%;padding:10px 12px;border-radius:12px}
    .user{align-self:flex-end;background:#1a2236}
    .bot{align-self:flex-start;background:#13202a;border:1px solid #1d3130}
    .chat-input{display:flex;gap:10px;padding:12px;background:#0e1526;border-top:1px solid #1d2436}
    .plan{white-space:pre-wrap}
    .muted{opacity:.8}
    .kbd{border:1px solid #2a3753;border-bottom-width:2px;border-radius:6px;padding:2px 6px;font-family:ui-monospace,monospace;font-size:12px;color:#cfe6ff}
    a{color:#8dd7ff;text-decoration:none}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
    .select{background:#0b1222;border:1px solid #26304a;border-radius:8px;padding:8px;color:var(--text);width:100%}
  </style>

  <!-- marked.js (Markdown renderer) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- âœ… pdf.js v4 is an ES module; import it and expose a global for our non-module script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.mjs" type="module"></script>
  <script type="module">
    import * as pdfjsLib from "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.mjs";
    window.pdfjsLib = pdfjsLib;            // make it available to the rest of the page
  </script>
</head>
<body>
  <header>
    <div class="container">
      <h1>ðŸŽ¤ Voice Coach</h1>
      <p class="muted">Upload your <strong>voice report PDF</strong> (Public Speaking / Karaoke / Podcast). Get tailored, non-medical tips. Runs entirely in your browser.</p>
    </div>
  </header>

  <main class="container">
    <div class="row">
      <section class="card">
        <h2>1) Upload Report</h2>
        <div class="uploader">
          <input id="pdfInput" type="file" accept="application/pdf" />
          <button class="ghost" id="demoBtn">Try Demo (no PDF)</button>
          <div class="row2">
            <label>
              Mode (auto from PDF or override)
              <select id="modeSelect" class="select">
                <option value="auto">Auto (from PDF)</option>
                <option value="public_speaking">Public Speaking</option>
                <option value="karaoke">Karaoke</option>
                <option value="podcast">Podcast</option>
              </select>
            </label>
            <label>
              Web help (optional)
              <select id="webToggle" class="select">
                <option value="off">Off (local tips only)</option>
                <option value="on">On (use /api/search if available)</option>
              </select>
            </label>
          </div>
          <p class="muted" style="margin-top:8px">Scanned image PDFs may not parse well. For web help you need a Netlify Function at <code>/api/search</code>.</p>
        </div>

        <h2 style="margin-top:16px">2) Findings</h2>
        <div id="metrics" class="metrics"></div>
        <div id="findings"></div>

        <h2 style="margin-top:16px">3) Practice Plan</h2>
        <div id="plan" class="plan card" style="background:#0e1424;border-color:#1d2436"></div>
        <div style="margin-top:10px;display:flex;gap:10px">
          <button id="downloadBtn" class="ghost">Download Plan (.md)</button>
          <button id="copyBtn" class="ghost">Copy Plan</button>
        </div>
      </section>

      <section class="card">
        <h2>Chat</h2>
        <div class="chat">
          <div id="chatLog" class="chat-log"></div>
          <div class="chat-input">
            <input id="chatText" type="text" placeholder="Ask breathing, clarity, projectionâ€¦ (off-topic gets a polite no)" style="flex:1;background:#0b1222;border:1px solid #26304a;border-radius:8px;padding:10px;color:var(--text)"/>
            <button id="sendBtn">Send</button>
          </div>
        </div>
        <div style="margin-top:12px">
          <p class="muted"><strong>Note:</strong> Educational guidance only; not medical advice. For clinical issues, consult a licensed SLP/ENT.</p>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:18px">
      <h2>Extracted Report Text (preview)</h2>
      <pre id="raw" style="white-space:pre-wrap;background:#0f1423;border:1px solid #1d2436;border-radius:12px;padding:12px;max-height:260px;overflow:auto;"></pre>
    </section>
  </main>

<script>
/* ---------------- State/refs ---------------- */
const $ = sel => document.querySelector(sel);
const metricsBox = $("#metrics");
const findingsBox = $("#findings");
const planBox = $("#plan");
const rawBox = $("#raw");
const modeSelect = $("#modeSelect");
const webToggle = $("#webToggle");

let lastPlanMD = "";
let reportText = "";
let detectedMode = "public_speaking"; // default

/* ---------------- PDF extraction ---------------- */
async function readPdf(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let fullText = "";
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const text = await page.getTextContent();
    fullText += text.items.map(it => it.str).join(" ") + "\n";
  }
  return fullText;
}

/* ---------------- Helpers ---------------- */
const toFloat = v => v==null?null:(n=>Number.isFinite(n)?n:null)(parseFloat(String(v).replace(/[^0-9.\-]/g,"")));
const find = (re, s) => (s.match(re)||[])[1];
function detectModeFrom(text){
  const t = text.toLowerCase();
  if (t.includes("karaoke")) return "karaoke";
  if (t.includes("public speaking")) return "public_speaking";
  if (t.includes("podcast")) return "podcast";
  return "public_speaking";
}

/* ---------------- Analysis & plan ---------------- */
function analyzeReport(text) {
  const t = text || "";
  const lower = t.toLowerCase();

  // metrics
  const metrics = {
    jitter_pct: toFloat(find(/jitter[^0-9%]*([0-9.]+)\s*%/i, t)),
    shimmer_pct: toFloat(find(/shimmer[^0-9%]*([0-9.]+)\s*%/i, t)),
    mpt_sec:    toFloat(find(/(?:maximum\s+phonation\s+time|mpt)[^0-9]*([0-9.]+)\s*s/i, t)),
    sz_ratio:   toFloat(find(/s\/z\s*ratio[^0-9]*([0-9.]+)/i, t)),
    f0_hz:      toFloat(find(/(?:f0|fundamental\s+frequency)[^0-9]*([0-9.]+)\s*hz/i, t)),
    intensity_db: toFloat(find(/(?:intensity|spl)[^0-9]*([0-9.]+)\s*db/i, t))
  };

  const findings = [];
  const blocks = [];

  // interpret
  if (metrics.jitter_pct!=null) {
    if (metrics.jitter_pct>1.0){
      findings.push(`Elevated jitter (${metrics.jitter_pct}%).`);
      blocks.push(["Pitch Stability", [
        "Hum glides lowâ†’highâ†’low (5 min).",
        "SOVT: straw phonation in water, 3 Ã— 1 min.",
        "Gentle sirens on 'ng' (3 min)."
      ]]);
    } else findings.push(`Jitter in typical range (${metrics.jitter_pct}%).`);
  }
  if (metrics.shimmer_pct!=null) {
    if (metrics.shimmer_pct>3.5){
      findings.push(`Elevated shimmer (${metrics.shimmer_pct}%).`);
      blocks.push(["Loudness Control", [
        "Crescendoâ€“decrescendo on 'ah' (5s up/5s down) Ã— 5.",
        "Lip trills at steady volume (3 min).",
        "Count 1â€“10: softâ†’mediumâ†’loudâ†’soft."
      ]]);
    } else findings.push(`Shimmer in typical range (${metrics.shimmer_pct}%).`);
  }
  if (metrics.mpt_sec!=null) {
    if (metrics.mpt_sec<15){
      findings.push(`Short MPT (${metrics.mpt_sec}s): breath support may be limited.`);
      blocks.push(["Breath Support", [
        "Diaphragmatic 4â€“4â€“6 Ã— 10.",
        "Sustain 'sss' and 'zzz' (6 reps each).",
        "Light panting â†’ slow 'ffff' exhale (5 min total)."
      ]]);
    } else findings.push(`MPT looks adequate (${metrics.mpt_sec}s).`);
  }
  if (metrics.sz_ratio!=null) {
    if (metrics.sz_ratio<0.8 || metrics.sz_ratio>1.2){
      findings.push(`S/Z ratio outside ~0.8â€“1.2: ${metrics.sz_ratio}.`);
      blocks.push(["Glottal Efficiency", [
        "Alternate /s/ and /z/, match durations (5 pairs).",
        "Resonant hums ('mmm') forward buzz (3 min).",
        "Straw phonation airâ†’voice (3 Ã— 1 min)."
      ]]);
    } else findings.push(`S/Z ratio in typical band (${metrics.sz_ratio}).`);
  }
  if (metrics.f0_hz!=null) findings.push(`F0: ${metrics.f0_hz} Hz.`);
  if (metrics.intensity_db!=null) findings.push(`Intensity: ${metrics.intensity_db} dB.`);

  // keywords
  const K = (...ws)=>ws.some(w=>lower.includes(w));
  if (K("hoarse","hoarseness","raspy")) blocks.push(["Anti-Fatigue", [
    "Hydrate 2â€“3 L/day.",
    "SOVT (straw/lip/tongue trills) 5â€“8 min/day.",
    "5-min quiet rest per heavy-use hour."
  ]]);
  if (K("nasal","nasality")) blocks.push(["Resonance Balance", [
    "â€˜mmmâ€™ â†’ â€˜maâ€™ keeping forward buzz.",
    "meeâ€“mayâ€“mahâ€“mohâ€“moo Ã— 3.",
    "Light Y-buzz phrases (3 min)."
  ]]);
  if (K("tension","pressed","strain")) blocks.push(["De-tension", [
    "Neck/shoulder stretches (no pain).",
    "Yawnâ€“sigh glides Ã— 10.",
    "Low-effort speaking for ~2 min."
  ]]);

  // mode-specific add-ons
  const mode = (modeSelect.value==="auto" ? detectedMode : modeSelect.value);
  if (mode==="public_speaking"){
    blocks.push(["Public Speaking Focus", [
      "Pace at ~140â€“160 wpm; breathe at punctuation.",
      "Projection without push: â€˜mmmâ€™ â†’ words.",
      "Articulation ladder: tongue twisters 3 min."
    ]]);
  } else if (mode==="karaoke"){
    blocks.push(["Karaoke Focus", [
      "5-step sirens before singing.",
      "Verse-only run-through at 70% volume.",
      "Crescendoâ€“decrescendo on vowels (5 reps)."
    ]]);
  } else if (mode==="podcast"){
    blocks.push(["Podcast Focus", [
      "Consistency set: read 2 paragraphs at even SPL.",
      "Mic discipline: 6â€“8 cm, 20Â° off-axis, pop-filter.",
      "Warm, close tone: hum-to-speech transitions."
    ]]);
  }

  // always include warm up/cool down
  blocks.push(["Daily Warm-up (5â€“7 min)", [
    "Neck/shoulder roll + jaw massage (1 min).",
    "Lip trills or straw phonation (2 min).",
    "Hums â†’ 5-step sirens (2â€“3 min)."
  ]]);
  blocks.push(["Cool-down (2â€“3 min)", [
    "Gentle hums, descending slides.",
    "SOVT 60â€“90 s.",
    "2 min quiet voice or rest."
  ]]);

  // dedup
  const dedup = {};
  for (const [title, items] of blocks){
    dedup[title] = dedup[title]||[];
    for (const it of items) if (!dedup[title].includes(it)) dedup[title].push(it);
  }
  const plan = Object.keys(dedup).map(t=>({title:t, items:dedup[t]}));
  return {metrics, findings, plan, mode};
}

/* ---------------- Rendering ---------------- */
function renderAnalysis(res) {
  metricsBox.innerHTML = "";
  const m = res.metrics;
  [["Jitter %",m.jitter_pct],["Shimmer %",m.shimmer_pct],["MPT (s)",m.mpt_sec],["S/Z ratio",m.sz_ratio],["F0 (Hz)",m.f0_hz],["Intensity (dB)",m.intensity_db]]
    .forEach(([k,v])=>{
      const div=document.createElement("div");
      div.className="metric";
      div.innerHTML=`<div class="muted">${k}</div><div style="font-weight:700;color:#cfe6ff">${v ?? "â€”"}</div>`;
      metricsBox.appendChild(div);
    });

  findingsBox.innerHTML = "";
  const modeLine = document.createElement("p");
  modeLine.innerHTML = `<strong>Detected/Selected Mode:</strong> ${res.mode.replace("_"," ")}`;
  findingsBox.appendChild(modeLine);

  if (res.findings?.length){
    const ul=document.createElement("ul");
    res.findings.forEach(f=>{const li=document.createElement("li"); li.textContent=f; ul.appendChild(li);});
    findingsBox.appendChild(ul);
  } else {
    findingsBox.innerHTML += `<p class="muted">No specific metrics foundâ€”plan still generated from general cues.</p>`;
  }

  let md = `# Personalized Voice Plan\n**Note:** Educational guidance only; not medical advice.\n\n`;
  if (res.findings?.length) md += `## Findings\n`+res.findings.map(f=>`- ${f}`).join("\n")+"\n\n";
  md += `## Practice Plan\n`;
  res.plan.forEach(b=>{
    md += `### ${b.title}\n` + b.items.map(i=>`- ${i}`).join("\n") + "\n\n";
  });
  lastPlanMD = md;
  planBox.innerHTML = marked.parse(md);
}

/* ---------------- Chat logic ---------------- */
const chatLog = $("#chatLog");
function addBubble(role, text){
  const div=document.createElement("div");
  div.className=`bubble ${role==="user"?"user":"bot"}`;
  div.innerHTML = role==="bot" ? marked.parse(text) : text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}

function isVoiceRelated(q){
  const p=q.toLowerCase();
  return /(voice|breath|breathing|sing|speak|speech|pitch|tone|resonance|articulation|karaoke|podcast|public|mpt|jitter|shimmer|s\/z|clarity|projection|fatigue|tension)/.test(p);
}

const bank = {
  breath: {
    base: [
      `**Breathing Mini-Block (6â€“8 min)**\n- Diaphragmatic 4â€“4â€“6 Ã— 10\n- Sustained /sss/ steady airstream Ã— 6\n- Straw phonation (airâ†’voice) 3 Ã— 60s\n- Read aloud; breathe at punctuation`,
      `**Airflow Builder**\n- Box breathing 4â€“4â€“4â€“4 for 2 min\n- Hiss "sss" then voiced "zzz" (5 reps each)\n- Long gentle 'ffff' exhale while counting`
    ],
    karaoke: [
      `**Singing Breath Set**\n- 5 step sirens on 'oo'\n- Phrase-by-phrase breaths at commas\n- 3Ã— 45s lip trills before chorus`
    ],
    public_speaking: [
      `**Speaking Breath Set**\n- Nose inhale, mouth exhale on punctuation\n- Read 2 paragraphs at even pace\n- 90s straw phonation to center airflow`
    ],
    podcast: [
      `**Podcast Breath Set**\n- 8 slow diaphragmatic breaths\n- Even SPL reading (2 min)\n- Soft humâ†’speech entries`
    ]
  },
  clarity: [
    `**Clarity & Diction**\n- Exaggerated tongue-twisters (3 min)\n- Consonant bursts: "p t k" â†’ phrases\n- Smile-read one paragraph`,
    `**Crisp Speech**\n- Count 1â€“20 over-articulated\n- Headline reading: emphasize consonants\n- 'mmm'â†’'ma' keeping forward buzz`
  ],
  projection: [
    `**Projection Without Push**\n- 'mmm' â†’ words (forward resonance)\n- Count 1â€“10 medium volume, throat relaxed\n- 3Ã— 45s lip trills`,
    `**Resonant Projection**\n- Y-buzz phrases (You, Youngâ€¦)\n- Vowel cresc/decresc 5s up/5s down Ã— 5\n- Jaw loose, chest quiet`
  ],
  fatigue: [
    `**Anti-Fatigue**\n- Hydrate; warm water\n- SOVT 5â€“8 min/day in short sets\n- 5-min quiet each heavy-use hour\n- Replace throat clearing with silent cough`,
    `**Recovery**\n- 2 min quiet hums\n- 60â€“90s straw phonation\n- Gentle descending slides`
  ],
  pitch: [
    `**Pitch Stability**\n- Hum glides lowâ†’highâ†’low (3 min)\n- 'ng' sirens\n- Straw phonation 3Ã—60s`,
    `**Smooth Registers**\n- 5-step sirens on "oo"\n- Glide into speech without breaks\n- Track comfort, not range`
  ]
};

async function maybeSearchWeb(q){
  if (webToggle.value !== "on") return null;
  try {
    const r = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
    if (!r.ok) throw new Error("search off");
    const data = await r.json();
    if (!Array.isArray(data?.items) || !data.items.length) return null;
    const top = data.items.slice(0,3).map(x=>`- [${x.title}](${x.link})`).join("\n");
    return `Here are helpful resources I found:\n${top}\n\n(Use with discretion; practice tips below are general.)`;
  } catch { return null; }
}

function modeAwareBreath(mode){
  const base = bank.breath.base[Math.floor(Math.random()*bank.breath.base.length)];
  const extraList = bank.breath[mode] || [];
  const extra = extraList.length ? "\n\n"+extraList[Math.floor(Math.random()*extraList.length)] : "";
  return base + extra;
}

async function replyFor(text){
  const p = text.toLowerCase();

  if (!isVoiceRelated(p)) {
    return "Iâ€™m focused on **voice improvement** (breathing, clarity, pitch, projection, resonance). I canâ€™t help with that request â€” try asking a voice-related question ðŸ™‚";
  }

  const web = await maybeSearchWeb(text);
  const mode = (modeSelect.value==="auto" ? detectedMode : modeSelect.value);

  if (/(breath|breathing|diaphragm|airflow|support)/.test(p)) return (web? web+"\n\n": "") + modeAwareBreath(mode);
  if (/(clarity|articulation|diction|pronunciation)/.test(p)) return (web? web+"\n\n": "") + bank.clarity[Math.floor(Math.random()*bank.clarity.length)];
  if (/(project|loud|volume)/.test(p))   return (web? web+"\n\n": "") + bank.projection[Math.floor(Math.random()*bank.projection.length)];
  if (/(hoarse|raspy|fatigue|tired)/.test(p)) return (web? web+"\n\n": "") + bank.fatigue[Math.floor(Math.random()*bank.fatigue.length)];
  if (/(pitch|jitter)/.test(p))          return (web? web+"\n\n": "") + bank.pitch[Math.floor(Math.random()*bank.pitch.length)];
  if (/(plan|routine|program|summary)/.test(p)) return (web? web+"\n\n": "") + (lastPlanMD || "Upload your PDF first and Iâ€™ll craft a plan.");
  return (web? web+"\n\n": "") + `**Quick Warm-up (5â€“6 min)**\n- Lip/tongue trills 2 min\n- Hum slides 2 min\n- Read a paragraph, breathe at punctuation`;
}

/* ---------------- Events ---------------- */
$("#pdfInput").addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  rawBox.textContent = "Reading PDFâ€¦";
  try {
    reportText = await readPdf(file);
    detectedMode = detectModeFrom(reportText);
    if (modeSelect.value==="auto") {
      const opt = Array.from(modeSelect.options).find(o=>o.value===detectedMode);
      if (opt) modeSelect.title = `Detected: ${opt.text}`;
    }
    rawBox.textContent = reportText;
    const res = analyzeReport(reportText);
    renderAnalysis(res);
  } catch (err) {
    rawBox.textContent = "[ERROR] Could not read PDF: " + err;
  }
});

$("#demoBtn").addEventListener("click", () => {
  reportText = `Session Information
  Processing Mode: Karaoke
  Duration: 103.8 seconds
  AI Enhancement: Enabled
  Performance Metrics
  Average Latency 48.07 ms
  Minimum Latency 15.41 ms
  Maximum Latency 100.99 ms
  Total Samples 4042752
  Processing Settings
  Pitch Correction 0.3
  Reverb Amount 0.4
  Notes: hoarseness after speaking, mild nasality.`;
  detectedMode = "karaoke";
  rawBox.textContent = reportText;
  const res = analyzeReport(reportText);
  renderAnalysis(res);
});

$("#downloadBtn").addEventListener("click", () => {
  if (!lastPlanMD) return;
  const blob = new Blob([lastPlanMD], {type:"text/markdown"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "voice_plan.md";
  a.click();
});

$("#copyBtn").addEventListener("click", async () => {
  if (!lastPlanMD) return;
  await navigator.clipboard.writeText(lastPlanMD);
  alert("Plan copied to clipboard!");
});

$("#sendBtn").addEventListener("click", async () => {
  const input = $("#chatText");
  const msg = input.value.trim();
  if (!msg) return;
  addBubble("user", msg);
  input.value = "";
  const reply = await replyFor(msg);
  addBubble("bot", reply);
});
</script>
</body>
</html>
